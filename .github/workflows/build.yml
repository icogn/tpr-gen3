name: Website Artifact
on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build_website:
    # permissions: write-all
    strategy:
      fail-fast: true
      matrix:
        # os: [windows-latest]
        os: [ubuntu-latest]
        # os: [ macos-latest, ubuntu-latest, windows-latest ]

    runs-on: ${{ matrix.os }}
    environment: ${{ vars.DEV_BRANCH_NAME }}

    steps:
      - uses: actions/checkout@v4

      # - uses: actions/setup-node@v4
      #   with:
      #     node-version: '20.17.0'
      # - name: Setup yarn
      #   run: npm install -g yarn

      - uses: actions/setup-node@v4
        with:
          node-version: '20.17.0'
          cache: 'yarn'

      - uses: qoomon/actions--context@v2
        name: Get environment name as var
        id: context

      - uses: kaisugi/action-regex-match@v1.0.1
        name: Check environment name is valid
        id: regex-match
        with:
          text: ${{ steps.context.outputs.environment }}
          regex: '^[a-z0-9]+$'

      - if: ${{ steps.regex-match.outputs.match == '' }}
        name: Exit if invalid environment name
        run: exit 1

      - run: yarn --immutable

      # Increment the build number ASAP (once we have a valid environment and yarn has run)
      - uses: ./scripts/workflows/increment
        name: Increment build number
        id: increment
        with:
          name: 'BUILD_NUMBER'
          token: ${{ secrets.GH_PAT }}
          environment: ${{ steps.context.outputs.environment }}

      # - run: |
      #     echo "Current Environment: ${{ steps.context.outputs.environment }}"
      #     echo "Job Logs: ${{ steps.context.outputs.job_log_url }}"

      - uses: martinbeentjes/npm-get-version-action@v1.3.1
        id: package-version
        name: Get root package.json version

      - run: echo ${{ steps.package-version.outputs.current-version }}

      - uses: matt-usurp/validate-semver@v2
        id: semver
        with:
          version: ${{ steps.package-version.outputs.current-version }}-${{ steps.context.outputs.environment }}.${{ vars.BUILD_NUMBER }}

      - run: |
          echo "v${{ steps.semver.outputs.version }}"
          echo "v${{ steps.semver.outputs.major }}"
          echo "v${{ steps.semver.outputs.minor }}"
          echo "v${{ steps.semver.outputs.patch }}"
          echo "v${{ steps.semver.outputs.prerelease }}"
          echo "v${{ steps.semver.outputs.build }}"

      - run: |
          gh variable list
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - run: echo ${{ vars.BUILD_NUMBER }}
      - run: echo ${{ steps.context.outputs.environment }}

      # - uses: ./scripts/ci/set-github-variable.js
      #   with:
      #     name: 'SAMPLE_VAR'
      #     value: 'Hello World'
      #     repository: mmoyaferrer/set-github-variable
      #     token: ${{ secrets.REPO_ACCESS_TOKEN }}

      - run: yarn --cwd website run build

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: asdf-${{ matrix.os }}
          include-hidden-files: true # so includes .next folder
          path: website/.next/standalone
